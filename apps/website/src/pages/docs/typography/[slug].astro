---
import Layout from "../../../layouts/Layout.astro";
import DocsLayout from "../../../components/docs/DocsLayout.svelte";
import StoryPreview from "../../../components/docs/StoryPreview.svelte";
import StoryWrapper from "../../../components/docs/StoryWrapper.svelte";
import PropsTable from "../../../components/docs/PropsTable.svelte";
import CodeBlock from "../../../components/docs/CodeBlock.astro";
import DescriptionText from "../../../components/docs/DescriptionText.svelte";
import { storyNameToDisplayName, getComponentName, generateTypographyAnatomy, toKebabCase, getStoryPropValue, buildTocItems, createStaticPathsFromModules } from "../../../lib/stories";

export async function getStaticPaths() {
	const modules = import.meta.glob("../../../../../storybook/stories/typography/*.stories.ts", { eager: true });
	return createStaticPathsFromModules(modules);
}

interface Props {
	componentName: string;
	meta: any;
	stories: Record<string, any>;
}

const { componentName, meta, stories } = Astro.props;
const { slug } = Astro.params;

const title = meta?.title ? getComponentName(meta.title) : componentName;

// Use custom anatomy from meta if available, otherwise generate a basic one
const anatomyCode = meta?.parameters?.anatomy || generateTypographyAnatomy(title, slug);

// Get sub-components if defined
const subComponents = meta?.parameters?.subComponents || [];
const hasProps = (meta?.argTypes && Object.keys(meta.argTypes).length > 0) || subComponents.length > 0;

const tocItems = buildTocItems(stories, meta, hasProps);
---

<Layout title={title}>
	<DocsLayout
		currentPath={`/docs/typography/${slug}`}
		tocItems={tocItems}
		client:load
	>
		<div class="pb-20">
			<h1 class="text-2xl font-semibold mb-4">{title}</h1>

			{meta?.parameters?.docs?.description?.component && (
				<p class="text-lg text-fg-muted mb-8">
					{meta.parameters.docs.description.component}
				</p>
			)}

			<h2 id="anatomy" class="text-xl font-semibold mt-12 mb-4 scroll-mt-20">Anatomy</h2>
			<CodeBlock code={anatomyCode} lang="svelte" class="mb-8" />

			<h2 id="examples" class="text-xl font-semibold mt-12 mb-4 scroll-mt-20">Examples</h2>

			{Object.entries(stories).map(([name, story]) => {
				const storyProp = getStoryPropValue(name);
				return (
					<section id={toKebabCase(name)} class="mb-12 scroll-mt-20">
						<h3 class="text-lg font-medium mb-2">{storyNameToDisplayName(name)}</h3>
						{story.parameters?.docs?.description?.story && (
							<p class="text-fg-muted mb-4">
								<DescriptionText text={story.parameters.docs.description.story} client:load />
							</p>
						)}
						<StoryPreview story={storyProp} client:load>
							<StoryWrapper component={componentName} story={storyProp} category="typography" client:load />
						</StoryPreview>
					</section>
				);
			})}

			{hasProps && (
				<>
					<h2 id="props" class="text-xl font-semibold mt-12 mb-4 scroll-mt-20">Props</h2>

					{subComponents.length > 0 ? (
						subComponents.map((sc: any) => (
							<div class="mb-8">
								<h3
									id={`props-${sc.name.toLowerCase().replace(/\./g, '-')}`}
									class="text-lg font-medium mb-3 scroll-mt-20"
								>
									{sc.name}
								</h3>
								{sc.description && (
									<p class="text-fg-muted mb-4 text-sm">{sc.description}</p>
								)}
								<PropsTable props={sc.props || {}} client:load />
							</div>
						))
					) : meta?.argTypes && Object.keys(meta.argTypes).length > 0 ? (
						<PropsTable props={meta.argTypes} isArgTypes client:load />
					) : null}
				</>
			)}
		</div>
	</DocsLayout>
</Layout>
