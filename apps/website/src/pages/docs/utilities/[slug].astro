---
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";
import { codeToHtml } from "shiki";
import Layout from "../../../layouts/Layout.astro";
import DocsLayout from "../../../components/docs/DocsLayout.svelte";
import StoryPreview from "../../../components/docs/StoryPreview.svelte";
import StoryWrapper from "../../../components/docs/StoryWrapper.svelte";
import PropsTable from "../../../components/docs/PropsTable.svelte";
import CodeBlock from "../../../components/docs/CodeBlock.astro";
import DescriptionText from "../../../components/docs/DescriptionText.svelte";
import { Alert } from "@saas-ui/svelte/components/alert";
import { storyNameToDisplayName, getComponentName, generateUtilitiesAnatomy, toKebabCase, getStoryPropValue, buildTocItems, createStaticPathsFromModules, extractStoryCode } from "../../../lib/stories";

export async function getStaticPaths() {
	const modules = import.meta.glob("../../../../../storybook/stories/utilities/*.stories.ts", { eager: true });
	return createStaticPathsFromModules(modules);
}

interface Props {
	componentName: string;
	meta: any;
	stories: Record<string, any>;
}

const { componentName, meta, stories } = Astro.props;
const { slug } = Astro.params;

// Read wrapper source file for code extraction
const __dirname = path.dirname(fileURLToPath(import.meta.url));
const wrapperPath = path.resolve(
	__dirname,
	"../../../../../storybook/stories/wrappers/utilities",
	`${componentName}.svelte`
);
let wrapperSource = "";
try {
	wrapperSource = fs.readFileSync(wrapperPath, "utf-8");
} catch {
	// Wrapper file not found, code tabs won't be shown
}

// Pre-highlight code for each story
const storyCodeMap: Record<string, { code: string; html: string }> = {};
for (const [name] of Object.entries(stories)) {
	const code = extractStoryCode(wrapperSource, name);
	if (code) {
		const html = await codeToHtml(code, {
			lang: "svelte",
			themes: {
				light: "github-light-high-contrast",
				dark: "github-dark-high-contrast",
			},
		});
		storyCodeMap[name] = { code, html };
	}
}

const title = meta?.title ? getComponentName(meta.title) : componentName;

// Use custom anatomy from meta if available, otherwise generate a basic one
const anatomyCode = meta?.parameters?.anatomy || generateUtilitiesAnatomy(title, slug);

// Get sub-components if defined
const subComponents = meta?.parameters?.subComponents || [];
const hasProps = (meta?.argTypes && Object.keys(meta.argTypes).length > 0) || subComponents.length > 0;

const tocItems = buildTocItems(stories, meta, hasProps);

// Get notice if defined
const notice = meta?.parameters?.notice;

const base = import.meta.env.BASE_URL || "";
---

<Layout title={title}>
	<DocsLayout
		currentPath={`${base}/docs/utilities/${slug}`}
		tocItems={tocItems}
		client:load
	>
		<div class="pb-20">
			<h1 class="mb-4 text-2xl font-semibold">{title}</h1>

			{notice && (
				<Alert status={notice.type || "warning"} class="mb-6" client:load>
					{notice.message}
				</Alert>
			)}

			{meta?.parameters?.docs?.description?.component && (
				<p class="mb-8 text-lg text-fg-muted">
					{meta.parameters.docs.description.component}
				</p>
			)}

			<h2 id="anatomy" class="mt-12 mb-4 text-xl font-semibold scroll-mt-20">Anatomy</h2>
			<CodeBlock code={anatomyCode} lang="svelte" class="mb-8" />

			<h2 id="examples" class="mt-12 mb-4 text-xl font-semibold scroll-mt-20">Examples</h2>

			{Object.entries(stories).map(([name, story]) => {
				const storyProp = getStoryPropValue(name);
				const storyCode = storyCodeMap[name];
				return (
					<section id={toKebabCase(name)} class="mb-12 scroll-mt-20">
						<h3 class="mb-2 text-lg font-medium">{storyNameToDisplayName(name)}</h3>
						{story.parameters?.docs?.description?.story && (
							<p class="mb-4 text-fg-muted">
								<DescriptionText text={story.parameters.docs.description.story} client:load />
							</p>
						)}
						<StoryPreview
							story={storyProp}
							code={storyCode?.code}
							codeHtml={storyCode?.html}
							client:load
						>
							<StoryWrapper component={componentName} story={storyProp} category="utilities" client:load />
						</StoryPreview>
					</section>
				);
			})}

			{hasProps && (
				<>
					<h2 id="props" class="mt-12 mb-4 text-xl font-semibold scroll-mt-20">Props</h2>

					{subComponents.length > 0 ? (
						subComponents.map((sc: any) => (
							<div class="mb-8">
								<h3
									id={`props-${sc.name.toLowerCase().replace(/\./g, '-')}`}
									class="mb-3 text-lg font-medium scroll-mt-20"
								>
									{sc.name}
								</h3>
								{sc.description && (
									<p class="mb-4 text-sm text-fg-muted">{sc.description}</p>
								)}
								<PropsTable props={sc.props || {}} client:load />
							</div>
						))
					) : meta?.argTypes && Object.keys(meta.argTypes).length > 0 ? (
						<PropsTable props={meta.argTypes} isArgTypes client:load />
					) : null}
				</>
			)}
		</div>
	</DocsLayout>
</Layout>
